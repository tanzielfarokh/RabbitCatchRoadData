Performance improvement and small bug fixes